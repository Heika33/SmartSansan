<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æ™ºèƒ½è§†é¢‘ç›‘æ§é¢„è­¦ç³»ç»Ÿ</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    label, select, input, button { margin: 5px; }
    video, img { width: 640px; height: 360px; background: #000; margin-top: 10px; }
    #alertBox { margin-top: 10px; padding: 10px; border: 1px solid red; background: #fee; }
    #statusIcon { font-weight: bold; font-size: 16px; }
    #historyList { margin-top: 10px; }
  </style>
</head>
<body>

<h2>ğŸ¥ æ™ºèƒ½è§†é¢‘ç›‘æ§é¢„è­¦ç³»ç»Ÿ</h2>

<div class="controls">
  <label for="sourceType">é€‰æ‹©è§†é¢‘æºï¼š</label>
  <select id="sourceType" onchange="updateSourceType()">
    <option value="device">æœ¬æœºæ‘„åƒå¤´</option>
    <option value="rtsp">å¤–æ¥æ‘„åƒå¤´ (RTSP)</option>
    <option value="upload">ä¸Šä¼ æœ¬åœ°è§†é¢‘</option>
  </select>

  <div id="cameraIndexRow" style="display:none;">
    <label for="cameraIndex">æœ¬æœºæ‘„åƒå¤´ç¼–å·ï¼š</label>
    <select id="cameraIndex"></select>
    <button onclick="detectCameras()">æ¢æµ‹æ‘„åƒå¤´</button>
  </div>

  <div id="videoPathRow" style="display:none;">
    <input type="text" id="videoPath" placeholder="è¯·è¾“å…¥ RTSP æˆ– æœ¬åœ°è·¯å¾„">
  </div>

  <div id="fileInputRow" style="display:none;">
    <input type="file" id="videoFile" accept="video/*">
  </div>

  <button onclick="startMonitoring()">â–¶ï¸ å¼€å§‹ç›‘æ§</button>
  <button onclick="pauseMonitoring()">â¸ æš‚åœ</button>
  <button onclick="stopMonitoring()">â¹ åœæ­¢</button>
  <span>çŠ¶æ€ï¼š<span id="statusIcon">âšªï¸ æœªå¯åŠ¨</span></span>
</div>

<h3>ğŸ“º å®æ—¶ç”»é¢</h3>
<img id="videoFeed" alt="ç­‰å¾…è§†é¢‘å¸§...">

<h3>ğŸš¨ å®æ—¶è­¦æŠ¥</h3>
<div id="alertBox">æš‚æ— è­¦æŠ¥</div>

<h3>ğŸ“œ å†å²è®°å½•</h3>
<div id="historyList">æš‚æ— è®°å½•</div>
<button onclick="loadHistory(-1)">ä¸Šä¸€é¡µ</button>
<button onclick="loadHistory(1)">ä¸‹ä¸€é¡µ</button>

<h3>ğŸ” ç›¸ä¼¼æŸ¥è¯¢</h3>
<input type="text" id="searchQuery" placeholder="è¾“å…¥æŸ¥è¯¢å†…å®¹">
<button onclick="searchSimilar()">æŸ¥è¯¢å†å²è§†é¢‘æè¿°</button>
<div id="searchResults"></div>

<h3>ğŸ—£ é—®ç­”ç³»ç»Ÿ</h3>
<input type="text" id="userQuestion" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜">
<button onclick="askQuestion()">æé—®</button>

<div id="answerBox">
    <p id="answer"></p>
</div>

<script>
let videoSocket, alertSocket;
let page = 1;

function updateSourceType() {
  const type = document.getElementById("sourceType").value;
  document.getElementById("cameraIndexRow").style.display = type === "device" ? "block" : "none";
  document.getElementById("videoPathRow").style.display = type === "rtsp" ? "block" : "none";
  document.getElementById("fileInputRow").style.display = type === "upload" ? "block" : "none";
}

function detectCameras() {
  fetch('/list_cameras')
    .then(res => res.json())
    .then(data => {
      const select = document.getElementById("cameraIndex");
      select.innerHTML = "";
      data.devices.forEach((label, index) => {
        const option = document.createElement("option");
        option.value = index;
        option.text = label;
        select.appendChild(option);
      });
    });
}

function askQuestion() {
    const query = document.getElementById("userQuestion").value;
    fetch(`/ask_question?query=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.answer) {
                document.getElementById("answer").innerText = data.answer;
            } else {
                document.getElementById("answer").innerText = "æŠ±æ­‰ï¼Œæ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜ã€‚";
            }
        });
}

function startMonitoring() {
  const type = document.getElementById("sourceType").value;

  if (type === "upload") {
    const file = document.getElementById("videoFile").files[0];
    if (!file) return alert("è¯·é€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶");
    const formData = new FormData();
    formData.append("file", file);
    fetch('/upload_video', {
      method: 'POST',
      body: formData
    }).then(res => res.json()).then(data => {
      if (data.success) {
        triggerStart("upload", data.path);
      } else {
        alert("è§†é¢‘ä¸Šä¼ å¤±è´¥");
      }
    });
  } else if (type === "device") {
    const cameraIndex = document.getElementById("cameraIndex").value;
    triggerStart("device", cameraIndex);
  } else if (type === "rtsp") {
    const path = document.getElementById("videoPath").value;
    triggerStart("rtsp", path);
  }
}

function triggerStart(type, path) {
  fetch('/start_monitoring', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ source_type: type, video_path: path })
  }).then(res => res.json()).then(data => {
    if (data.message) {
      connectSockets();
      updateStatus();
    } else {
      alert("å¯åŠ¨å¤±è´¥ï¼š" + JSON.stringify(data));
    }
  });
}

function pauseMonitoring() {
  fetch('/pause_monitoring', { method: 'POST' }).then(updateStatus);
}

function stopMonitoring() {
  fetch('/stop_monitoring', { method: 'POST' }).then(updateStatus);
  if (videoSocket) videoSocket.close();
  if (alertSocket) alertSocket.close();
}
function connectSockets() {
  const img = document.getElementById("videoFeed");

  videoSocket = new WebSocket("ws://" + location.host + "/video_feed");
  videoSocket.binaryType = "arraybuffer";
  videoSocket.onmessage = event => {
    const blob = new Blob([event.data], { type: "image/jpeg" });
    img.src = URL.createObjectURL(blob);
  };

  alertSocket = new WebSocket("ws://" + location.host + "/alerts");
  alertSocket.onmessage = event => {
    const data = JSON.parse(event.data);
    document.getElementById("alertBox").innerHTML = `
      <strong>æ—¶é—´:</strong> ${data.timestamp}<br>
      <strong style="color:red;">${data.alert}</strong><br>
      <pre>${data.description}</pre>
    `;
  };
}

function updateStatus() {
  fetch('/status').then(res => res.json()).then(data => {
    const map = {
      "idle": "âšªï¸ æœªå¯åŠ¨",
      "running": "ğŸŸ¢ è¿è¡Œä¸­",
      "paused": "ğŸŸ¡ å·²æš‚åœ",
      "stopped": "ğŸ”´ å·²åœæ­¢"
    };
    document.getElementById("statusIcon").textContent = map[data.status] || "â“";
  });
}

function loadHistory(delta) {
  page = Math.max(1, page + delta);
  fetch(`/get_history?page=${page}&size=5`)
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById("historyList");
      list.innerHTML = data.items.map((item, i) =>
        `<div><strong>#${(data.page - 1) * data.size + i + 1}</strong><br>${item}</div>`
      ).join("<hr>");
    });
}

function searchSimilar() {
    const query = document.getElementById("searchQuery").value;
    fetch(`/search_similar?query=${query}`)
        .then(res => res.json())
        .then(data => {
            const resultsDiv = document.getElementById("searchResults");
            resultsDiv.innerHTML = data.results.join("<br>");
        });
}

// åˆå§‹åŒ–
updateSourceType();
updateStatus();
loadHistory(0);
</script>

</body>
</html>
