<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æ™ºèƒ½è§†é¢‘ç›‘æ§é¢„è­¦ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="/static/css/app.css">
</head>
<body>
  <div class="page-container">
    <header class="page-header">
      <h1>ğŸ¥ æ™ºèƒ½è§†é¢‘ç›‘æ§é¢„è­¦ç³»ç»Ÿ</h1>
      <div class="status-badge">
        å½“å‰çŠ¶æ€ï¼š
        <span id="statusIcon" class="status-indicator idle">
          <span class="dot"></span>
          <span class="label">âšªï¸ æœªå¯åŠ¨</span>
        </span>
      </div>
    </header>

    <main class="layout">
      <div class="stack">
        <section class="card controls-card">
          <h2>ğŸ› è§†é¢‘æºæ§åˆ¶</h2>
          <div class="controls-grid">
            <div class="form-group">
              <label for="sourceType">é€‰æ‹©è§†é¢‘æº</label>
              <select id="sourceType" onchange="updateSourceType()">
                <option value="device">æœ¬æœºæ‘„åƒå¤´</option>
                <option value="rtsp">å¤–æ¥æ‘„åƒå¤´ (RTSP)</option>
                <option value="upload">ä¸Šä¼ æœ¬åœ°è§†é¢‘</option>
              </select>
            </div>

            <div class="form-group" id="cameraIndexRow" style="display:none;">
              <label for="cameraIndex">æ‘„åƒå¤´ç¼–å·</label>
              <div class="button-row">
                <select id="cameraIndex" style="flex:1;"></select>
                <button class="secondary" onclick="detectCameras()">æ¢æµ‹</button>
              </div>
            </div>

            <div class="form-group" id="videoPathRow" style="display:none;">
              <label for="videoPath">RTSP / æœ¬åœ°è·¯å¾„</label>
              <input type="text" id="videoPath" placeholder="è¯·è¾“å…¥ RTSP æˆ– æœ¬åœ°è·¯å¾„">
            </div>

            <div class="form-group" id="fileInputRow" style="display:none;">
              <label for="videoFile">ä¸Šä¼ æœ¬åœ°è§†é¢‘</label>
              <input type="file" id="videoFile" accept="video/*">
            </div>

            <div class="button-row">
              <button class="primary" onclick="startMonitoring()">â–¶ï¸ å¼€å§‹ç›‘æ§</button>
              <button class="secondary" onclick="pauseMonitoring()">â¸ æš‚åœ</button>
              <button class="danger" onclick="stopMonitoring()">â¹ åœæ­¢</button>
            </div>
          </div>
        </section>

        <section class="card history-card">
          <h2>ğŸ“œ å†å²è®°å½•</h2>
          <div id="historyList" class="history-list timeline">
            <div class="empty-state">æš‚æ— è®°å½•</div>
          </div>
          <div class="history-pagination">
            <button class="secondary" onclick="loadHistory(-1)">ä¸Šä¸€é¡µ</button>
            <button class="secondary" onclick="loadHistory(1)">ä¸‹ä¸€é¡µ</button>
          </div>
        </section>
      </div>

      <div class="stack">
        <section class="card video-panel">
          <h2>ğŸ“º å®æ—¶ç”»é¢</h2>
          <img id="videoFeed" alt="ç­‰å¾…è§†é¢‘å¸§...">

          <h3>ğŸš¨ å®æ—¶è­¦æŠ¥</h3>
          <div id="alertBox" class="alert-box">æš‚æ— è­¦æŠ¥</div>
        </section>

        <section class="card qa-card">
          <h2>ğŸ§  æ™ºèƒ½é—®ç­”</h2>
          <p>ç›´æ¥è¾“å…¥è‡ªç„¶è¯­è¨€é—®é¢˜ï¼Œæˆ–ä½¿ç”¨ä¸‹æ–¹å¿«æ·é—®é¢˜è¿›è¡ŒæŸ¥è¯¢ã€‚</p>
          <div class="qa-quick">
            <button class="quick-question" onclick="setQuickQuestion('ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ', true)">ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆ</button>
            <button class="quick-question" onclick="setQuickQuestion('æœ¬å‘¨æ˜¯å¦æœ‰å¼‚å¸¸äº‹ä»¶ï¼Ÿ', true)">æœ¬å‘¨å¼‚å¸¸</button>
            <button class="quick-question" onclick="setQuickQuestion('ä»‹ç»ä½ çš„åŠŸèƒ½ã€‚', true)">ä»‹ç»ä½ çš„åŠŸèƒ½</button>
          </div>
          <div class="input-row">
            <input type="text" id="userQuestion" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œå¦‚ï¼šé»‘è¡£ç”·å­ä»Šå¤©å‡ºç°äº†å‡ æ¬¡ï¼Ÿ">
            <button class="primary" onclick="askQuestion()">æé—®</button>
          </div>
          <div class="qa-meta">
            <span class="mode-badge" id="qaModeBadge">ç›‘æ§æ¨¡å¼</span>
            <span class="qa-note" id="qaModeNote">åŸºäºå†å²ç›‘æ§è®°å½•</span>
          </div>
          <div class="qa-status" id="qaStatus">ç­‰å¾…æé—®...</div>
          <div class="answer-summary" id="answerSummary"></div>
          <div class="stats-grid" id="answerStats"></div>
          <div class="match-list" id="matchList"></div>
          <div class="reference-list" id="referenceList"></div>
        </section>
      </div>
    </main>
  </div>

<script>
let videoSocket, alertSocket;
let page = 1;

function updateSourceType() {
  const type = document.getElementById("sourceType").value;
  document.getElementById("cameraIndexRow").style.display = type === "device" ? "block" : "none";
  document.getElementById("videoPathRow").style.display = type === "rtsp" ? "block" : "none";
  document.getElementById("fileInputRow").style.display = type === "upload" ? "block" : "none";
}

function detectCameras() {
  fetch('/list_cameras')
    .then(res => res.json())
    .then(data => {
      const select = document.getElementById("cameraIndex");
      select.innerHTML = "";
      data.devices.forEach((label, index) => {
        const option = document.createElement("option");
        option.value = index;
        option.text = label;
        select.appendChild(option);
      });
    });
}

function startMonitoring() {
  const type = document.getElementById("sourceType").value;

  if (type === "upload") {
    const file = document.getElementById("videoFile").files[0];
    if (!file) return alert("è¯·é€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶");
    const formData = new FormData();
    formData.append("file", file);
    fetch('/upload_video', {
      method: 'POST',
      body: formData
    }).then(res => res.json()).then(data => {
      if (data.success) {
        triggerStart("upload", data.path);
      } else {
        alert("è§†é¢‘ä¸Šä¼ å¤±è´¥");
      }
    });
  } else if (type === "device") {
    const cameraIndex = document.getElementById("cameraIndex").value;
    triggerStart("device", cameraIndex);
  } else if (type === "rtsp") {
    const path = document.getElementById("videoPath").value;
    triggerStart("rtsp", path);
  }
}

function triggerStart(type, path) {
  fetch('/start_monitoring', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ source_type: type, video_path: path })
  }).then(res => res.json()).then(data => {
    if (data.message) {
      connectSockets();
      updateStatus();
    } else {
      alert("å¯åŠ¨å¤±è´¥ï¼š" + JSON.stringify(data));
    }
  });
}

function pauseMonitoring() {
  fetch('/pause_monitoring', { method: 'POST' }).then(updateStatus);
}

function stopMonitoring() {
  fetch('/stop_monitoring', { method: 'POST' }).then(updateStatus);
  if (videoSocket) videoSocket.close();
  if (alertSocket) alertSocket.close();
}
function connectSockets() {
  const img = document.getElementById("videoFeed");

  videoSocket = new WebSocket("ws://" + location.host + "/video_feed");
  videoSocket.binaryType = "arraybuffer";
  videoSocket.onmessage = event => {
    const blob = new Blob([event.data], { type: "image/jpeg" });
    img.src = URL.createObjectURL(blob);
  };

  alertSocket = new WebSocket("ws://" + location.host + "/alerts");
  alertSocket.onmessage = event => {
    const data = JSON.parse(event.data);
    document.getElementById("alertBox").innerHTML = `
      <strong>æ—¶é—´:</strong> ${data.timestamp}<br>
      <strong style="color:red;">${data.alert}</strong><br>
      <pre>${data.description}</pre>
    `;
  };
}

function updateStatus() {
  fetch('/status').then(res => res.json()).then(data => {
    const map = {
      "idle": "âšªï¸ æœªå¯åŠ¨",
      "running": "ğŸŸ¢ è¿è¡Œä¸­",
      "paused": "ğŸŸ¡ å·²æš‚åœ",
      "stopped": "ğŸ”´ å·²åœæ­¢"
    };
    const statusElem = document.getElementById("statusIcon");
    statusElem.querySelector(".label").textContent = map[data.status] || "â“";
    statusElem.classList.remove("running", "paused", "stopped", "idle");
    statusElem.classList.add(data.status || "idle");
  });
}

function loadHistory(delta) {
  page = Math.max(1, page + delta);
  fetch(`/get_history?page=${page}&size=5`)
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById("historyList");
      if (!data.items.length) {
        list.innerHTML = '<div class="empty-state">æš‚æ— è®°å½•</div>';
        return;
      }
      list.innerHTML = data.items.map((item, i) => {
        const idx = (data.page - 1) * data.size + i + 1;
        return `
          <div class="timeline-item">
            <div class="content">
              <div class="meta">#${idx}</div>
              <div>${item}</div>
            </div>
          </div>
        `;
      }).join("");
    });
}

function renderAnswer(data) {
  const summary = document.getElementById("answerSummary");
  const statsContainer = document.getElementById("answerStats");
  const matchList = document.getElementById("matchList");
  const mode = data.mode || "monitor";
  const intent = data.intent || "describe";
  const modeBadge = document.getElementById("qaModeBadge");
  const modeNote = document.getElementById("qaModeNote");
  const references = document.getElementById("referenceList");

  summary.textContent = data.answer || "æš‚æ— æ˜ç¡®å›ç­”ã€‚";
  modeBadge.textContent = mode === "monitor" ? "ç›‘æ§æ¨¡å¼" : "é€šç”¨æ¨¡å¼";
  modeBadge.classList.toggle("general", mode !== "monitor");
  modeNote.textContent = data.note || (mode === "monitor" ? "åŸºäºå†å²ç›‘æ§è®°å½•" : "ä¸å¼•ç”¨ç›‘æ§è®°å½•");

  const stats = [];
  if (
    mode === "monitor" &&
    intent === "count" &&
    data.stats &&
    typeof data.stats.count === "number"
  ) {
    stats.push(`<div class="stat-card"><span>å‡ºç°æ¬¡æ•°</span><strong>${data.stats.count}</strong></div>`);
    if (data.stats.first_seen) {
      stats.push(`<div class="stat-card"><span>æœ€æ—©å‡ºç°</span><strong>${data.stats.first_seen}</strong></div>`);
    }
    if (data.stats.last_seen) {
      stats.push(`<div class="stat-card"><span>æœ€è¿‘å‡ºç°</span><strong>${data.stats.last_seen}</strong></div>`);
    }
  } else if (
    mode === "monitor" &&
    intent === "exists" &&
    data.stats &&
    typeof data.stats.exists === "string"
  ) {
    stats.push(`<div class="stat-card"><span>æ˜¯å¦å­˜åœ¨</span><strong>${data.stats.exists}</strong></div>`);
  }
  statsContainer.innerHTML = stats.join("");

  if (mode === "monitor" && data.matches && data.matches.length) {
    matchList.innerHTML = data.matches.map((match, idx) => `
      <div class="match-item">
        <div class="meta">#${idx + 1} ${match.timestamp || ""}</div>
        <div>${match.description}</div>
        ${match.reason ? `<div class="meta">åˆ¤å®šä¾æ®ï¼š${match.reason}</div>` : ""}
      </div>
    `).join("");
  } else if (mode === "monitor") {
    const message = data.note || "æœªæ‰¾åˆ°ç›¸å…³è®°å½•";
    matchList.innerHTML = `<div class="empty-state">${message}</div>`;
  } else {
    matchList.innerHTML = data.note ? `<div class="empty-state">${data.note}</div>` : "";
  }

  if (data.sources && data.sources.length) {
    references.innerHTML = data.sources.map((src, idx) => `
      <div class="reference-card">
        <strong>å¼•ç”¨ ${idx + 1}</strong>
        <p>${src}</p>
      </div>
    `).join("");
  } else {
    references.innerHTML = "";
  }

  if (mode === "general") {
    statsContainer.innerHTML = "";
    if (!data.note) {
      data.note = "è¯¥é—®é¢˜å±äºé€šç”¨é—®ç­”ï¼Œå›ç­”ä¸å¼•ç”¨ç›‘æ§è®°å½•ã€‚";
    }
    matchList.innerHTML = `<div class="empty-state">${data.note}</div>`;
  }
}

function setQAStatus(message, type = "info") {
  const qaStatus = document.getElementById("qaStatus");
  qaStatus.textContent = message;
  qaStatus.dataset.type = type;
}

function setQuickQuestion(text, auto = false) {
  const input = document.getElementById("userQuestion");
  input.value = text;
  input.focus();
  if (auto) {
    askQuestion(true);
  }
}

function askQuestion(autoTriggered = false) {
  const input = document.getElementById("userQuestion");
  const query = input.value.trim();
  if (!query) {
    setQAStatus("è¯·è¾“å…¥é—®é¢˜åå†æ¬¡æé—®ã€‚", "warning");
    return;
  }
  setQAStatus(autoTriggered ? "å·²ä½¿ç”¨å¿«æ·é—®é¢˜ï¼Œæ­£åœ¨æ£€ç´¢..." : "æ­£åœ¨åˆ†æï¼Œè¯·ç¨å€™...", "loading");
  fetch(`/ask_question?query=${encodeURIComponent(query)}`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        setQAStatus(data.error, "error");
        return;
      }
      setQAStatus("åˆ†æå®Œæˆã€‚", "success");
      renderAnswer(data);
    })
    .catch(() => {
      setQAStatus("é—®ç­”æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚", "error");
    });
}

// åˆå§‹åŒ–
updateSourceType();
updateStatus();
loadHistory(0);
</script>

</body>
</html>
